
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Fault injection Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../cleanup/destroy.html" />
    
    
    <link rel="prev" href="traffic-shifting.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../hints.html">
            
                <a href="../hints.html">
            
                    
                    Workshop hints
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Setup</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../setup/kubernetes.html">
            
                <a href="../setup/kubernetes.html">
            
                    
                    Provision a K8S cluster
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../setup/istio.html">
            
                <a href="../setup/istio.html">
            
                    
                    Install Istio Service Mesh
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../setup/test-application.html">
            
                <a href="../setup/test-application.html">
            
                    
                    Deploy test application
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Observability</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../observability/grafana.html">
            
                <a href="../observability/grafana.html">
            
                    
                    Service metrics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../observability/Jaeger.html">
            
                <a href="../observability/Jaeger.html">
            
                    
                    Distributed tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../observability/kiali.html">
            
                <a href="../observability/kiali.html">
            
                    
                    Mesh topology
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Traffic management</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="ingress-gateway.html">
            
                <a href="ingress-gateway.html">
            
                    
                    Ingress gateway
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="traffic-routing.html">
            
                <a href="traffic-routing.html">
            
                    
                    Traffic routing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="traffic-shifting.html">
            
                <a href="traffic-shifting.html">
            
                    
                    Traffic shifting
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="4.4" data-path="fault-injection.html">
            
                <a href="fault-injection.html">
            
                    
                    Fault injection
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Cleanup</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../cleanup/destroy.html">
            
                <a href="../cleanup/destroy.html">
            
                    
                    Destroy the cluster
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Fault injection</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="ingress-gateway">Ingress gateway</h1>
<p><em>This chapter presents how to inject faults into service mesh to test application resilency against service failures.</em></p>
<h2 id="outline">Outline</h2>
<p>In this chapter you will learn:</p>
<ul>
<li>What is <em>Fault Injection</em>.</li>
<li>How to inject delay and abort faults into a service mesh.</li>
</ul>
<h2 id="walkthrough">Walkthrough</h2>
<p><em>Fault injection</em> is a testing method that introduces errors into a system to ensure that it can withstand and recover from error conditions.</p>
<p>Unlike other mechanisms for introducing errors such as delaying packets or killing pods at the network layer, Istio proxy enables injecting faults at the application layer. That allows operators to inject more relevant failures, such as HTTP error codes.</p>
<p>Istio supports two categories of faults, both configured using a <code>VirtualService</code> policy:</p>
<ul>
<li>delays - timing failures, mimic increased network latency or an overloaded upstream service,</li>
<li>aborts - crash failures, mimic failures in upstream services (HTTP error codes or TCP connection failures).</li>
</ul>
<p>In this chapter, we will inject both types of faults into the test application and observe how it handles the failure.</p>
<h3 id="inject-http-delay-fault">Inject HTTP delay fault</h3>
<p>In this scenario we will inject a delay fault into the <code>payment</code> service.</p>
<p>Start with applying the fault policy:</p>
<pre><code>$ kubectl -n default apply -f ./release/istio/paymentservice-fault-vs-1.yaml
virtualservice.networking.istio.io/paymentservice configured
</code></pre><p>Inspect its details:</p>
<pre><code>$ kubectl -n default describe vs paymentservice
</code></pre><pre><code class="lang-yaml"><span class="hljs-attr">Name:</span>         paymentservice
<span class="hljs-attr">Namespace:</span>    default
...
<span class="hljs-attr">Spec:</span>
<span class="hljs-attr">  Hosts:</span>
    paymentservice
<span class="hljs-attr">  Http:</span>
<span class="hljs-attr">    Fault:</span>
<span class="hljs-attr">      Delay:</span>
        Fixed Delay:  <span class="hljs-number">7</span>s
<span class="hljs-attr">        Percentage:</span>
<span class="hljs-attr">          Value:</span>  <span class="hljs-number">100</span>
<span class="hljs-attr">    Route:</span>
<span class="hljs-attr">      Destination:</span>
<span class="hljs-attr">        Host:</span>    paymentservice
<span class="hljs-attr">        Subset:</span>  v1
</code></pre>
<p>The above configuration injects 7s delay for 100% percent of the traffic to the <code>payment</code> service.</p>
<p>Now, visit the test application in your web browser. Order one item and proceed to the checkout stage:</p>
<p><img src="../assets/images/fault-injection-place-order.png" alt=""></p>
<p>Before placing the order, open the network analyzer tool provided by your web browser:</p>
<p><img src="../assets/images/fault-injection-inspect.png" alt=""></p>
<p>Filter out the requests to the <code>checkout</code> service:</p>
<p><img src="../assets/images/fault-injection-inspect-filter.png" alt=""></p>
<p>Place the order. The operation should complete with the 7s delay:</p>
<p><img src="../assets/images/fault-injection-delay-1.png" alt=""></p>
<p>The <code>checkout</code> service communicates with the <code>payment</code> service, hence the delay occurred.</p>
<p>The 7s delay was handled gracefully by the application. Let&apos;s rise the delay to 120s to emulate a severe network congestion:</p>
<pre><code>$ kubectl -n default apply -f ./release/istio/paymentservice-fault-vs-2.yaml
virtualservice.networking.istio.io/paymentservice configured
</code></pre><p>Add another item and place the order. This time the application should fail and expose the <code>500 Internal Server Error</code> to the user:</p>
<p><img src="../assets/images/fault-injection-delay-2.png" alt=""></p>
<p>In production environment, applications must always hide internal errors from the end user. In addition, the application should configure a request timeout.</p>
<h3 id="inject-http-abort-fault">Inject HTTP abort fault</h3>
<p>In this scenario we will inject an abort fault into the <code>productcatalog</code> service.</p>
<p>Apply the following fault policy:</p>
<pre><code>$ kubectl -n default apply -f ./release/istio/productcatalogservice-fault-vs-1.yaml
virtualservice.networking.istio.io/productcatalogservice configured
</code></pre><p>Inspect its details:</p>
<pre><code>$ kubectl -n default describe vs productcatalogservice
</code></pre><pre><code class="lang-yaml"><span class="hljs-attr">Name:</span>         productcatalogservice
<span class="hljs-attr">Namespace:</span>    default
...
<span class="hljs-attr">Spec:</span>
<span class="hljs-attr">  Hosts:</span>
    productcatalogservice
<span class="hljs-attr">  Http:</span>
<span class="hljs-attr">    Fault:</span>
<span class="hljs-attr">      Abort:</span>
        Http Status:  <span class="hljs-number">500</span>
<span class="hljs-attr">        Percentage:</span>
<span class="hljs-attr">          Value:</span>  <span class="hljs-number">30</span>
<span class="hljs-attr">    Route:</span>
<span class="hljs-attr">      Destination:</span>
<span class="hljs-attr">        Host:</span>    productcatalogservice
<span class="hljs-attr">        Subset:</span>  v1
</code></pre>
<p>The above configuration injects 500 error for 30% percent of the traffic to the <code>productcatalog</code> service.</p>
<p>Refresh the main page of the test application several times to observe the error message exposed to the user:</p>
<p><img src="../assets/images/fault-injection-abort.png" alt=""></p>
<p>Again, the application should hide the internal error from the user and instead display a gentle warning, for instance:</p>
<pre><code>Product Catalog is temporarily unavailable. Sorry for inconvenience.`
</code></pre>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="traffic-shifting.html" class="navigation navigation-prev " aria-label="Previous page: Traffic shifting">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../cleanup/destroy.html" class="navigation navigation-next " aria-label="Next page: Destroy the cluster">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Fault injection","level":"4.4","depth":1,"next":{"title":"Destroy the cluster","level":"5.1","depth":1,"path":"cleanup/destroy.md","ref":"cleanup/destroy.md","articles":[]},"previous":{"title":"Traffic shifting","level":"4.3","depth":1,"path":"traffic-management/traffic-shifting.md","ref":"traffic-management/traffic-shifting.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"traffic-management/fault-injection.md","mtime":"2020-06-07T13:09:27.692Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-06-07T14:13:11.270Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

