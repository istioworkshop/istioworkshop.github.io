
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Traffic shifting Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="fault-injection.html" />
    
    
    <link rel="prev" href="traffic-routing.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../hints.html">
            
                <a href="../hints.html">
            
                    
                    Workshop hints
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Setup</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../setup/kubernetes.html">
            
                <a href="../setup/kubernetes.html">
            
                    
                    Provision a K8S cluster
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../setup/istio.html">
            
                <a href="../setup/istio.html">
            
                    
                    Install Istio Service Mesh
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../setup/test-application.html">
            
                <a href="../setup/test-application.html">
            
                    
                    Deploy test application
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Observability</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../observability/grafana.html">
            
                <a href="../observability/grafana.html">
            
                    
                    Service metrics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../observability/Jaeger.html">
            
                <a href="../observability/Jaeger.html">
            
                    
                    Distributed tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../observability/kiali.html">
            
                <a href="../observability/kiali.html">
            
                    
                    Mesh topology
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Traffic management</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="ingress-gateway.html">
            
                <a href="ingress-gateway.html">
            
                    
                    Ingress gateway
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="traffic-routing.html">
            
                <a href="traffic-routing.html">
            
                    
                    Traffic routing
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="4.3" data-path="traffic-shifting.html">
            
                <a href="traffic-shifting.html">
            
                    
                    Traffic shifting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="fault-injection.html">
            
                <a href="fault-injection.html">
            
                    
                    Fault injection
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Cleanup</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../cleanup/stop.html">
            
                <a href="../cleanup/stop.html">
            
                    
                    Stop the cluster
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../cleanup/destroy.html">
            
                <a href="../cleanup/destroy.html">
            
                    
                    Destroy the cluster
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Traffic shifting</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="traffic-shifting">Traffic shifting</h1>
<p><em>This chapter presents how to conduct a canary release of a new service version using Istio traffic shifting functionality.</em></p>
<h2 id="outline">Outline</h2>
<p>In this chapter you will learn:</p>
<ul>
<li>What is <em>Canary Release</em> and why it is important.</li>
<li>How to rollout a complete canary release using traffic shifting functionality.</li>
</ul>
<h2 id="walkthrough">Walkthrough</h2>
<blockquote>
<p><strong>Canary release</strong> is a technique to reduce the risk of introducing a new software version in production by slowly rolling out the change to a small subset of users before rolling it out to the entire infrastructure and making it available to everybody. ~ <em>Martin Fowler</em></p>
</blockquote>
<p>One of the benefits of using Istio is that it provides the control needed to deploy canary services. The idea behind canary deployment is to introduce a new version of a service by first testing it using a small percentage of user traffic, and then if all goes well, increase, possibly gradually in increments, the percentage while simultaneously phasing out the old version. If anything goes wrong along the way, we abort and rollback to the previous version. In its simplest form, the traffic sent to the canary version is a percentage of requests, but in more sophisticated schemes it can be based on the region, user, or other properties of the request.</p>
<p>In this chapter we will conduct a canary release of the version <code>v2</code> of the <code>productcatalog</code> service.</p>
<h3 id="shift-traffic-towards-new-app-version">Shift traffic towards new app version</h3>
<p>Open the Kiali dashboard:</p>
<pre><code>$ istioctl dashboard kiali
</code></pre><p>Then, switch to the graph view, select <em>Versioned app graph</em> type, and enable <em>Request percentage</em> in the edge label dropdown. The graph should display a similar structure:</p>
<p><img src="../assets/images/traffic-shifting-1.png" alt=""></p>
<p>Note that initially all user traffic should be routed to the version <code>v1</code> of the <code>productcatalog</code> service.</p>
<p>In order to start the canary deployment, apply the <code>VirtualService</code> policy:</p>
<pre><code>$ kubectl -n default apply -f ./release/istio/productcatalogservice-vs-1.yaml
</code></pre><p>Inspect its content:</p>
<pre><code>$ kubectl -n default describe vs productcatalog
</code></pre><pre><code class="lang-yaml"><span class="hljs-attr">Name:</span>         productcatalogservice
<span class="hljs-attr">Namespace:</span>    default
...
<span class="hljs-attr">Spec:</span>
<span class="hljs-attr">  Hosts:</span>
    productcatalogservice
<span class="hljs-attr">  Http:</span>
<span class="hljs-attr">    Route:</span>
<span class="hljs-attr">      Destination:</span>
<span class="hljs-attr">        Host:</span>    productcatalogservice
<span class="hljs-attr">        Subset:</span>  v1
<span class="hljs-attr">      Weight:</span>    <span class="hljs-number">90</span>
<span class="hljs-attr">      Destination:</span>
<span class="hljs-attr">        Host:</span>    productcatalogservice
<span class="hljs-attr">        Subset:</span>  v2
<span class="hljs-attr">      Weight:</span>    <span class="hljs-number">10</span>
</code></pre>
<p>The above policy enforces distributing the traffic between versions <code>v1</code> and <code>v2</code> of the <code>productcatalog</code> service in 9:1 ratio (<code>Weight</code> parameter). 90% of the traffic will be routed to the version <code>v1</code>. The remaining 10% will be routed to the version <code>v2</code>.</p>
<p>Observe the Kiali dashboard. After 1-2 minutes, the version routing should be reflected in the mesh:</p>
<p><img src="../assets/images/traffic-shifting-2.png" alt=""></p>
<p>In the meantime, we should continuously observe the essential health parameters for the new service workload (success rate, latency).</p>
<p>Open the Grafana dashboard:</p>
<pre><code>$ istioctl dashboard grafana
</code></pre><p>Navigate to the <a href="http://localhost:3000/d/G8wLrJIZk/istio-mesh-dashboard" target="_blank"><strong>Mesh Dashboard</strong></a> and observe the success rate for the <code>v2</code> workload:</p>
<p><img src="../assets/images/traffic-shifting-3.png" alt=""></p>
<p>In case, something went wrong, we could immadiately rollback the traffic to the old service version. For instance, by applying the following <code>VirtualService</code> policy:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">Name:</span>         productcatalogservice
<span class="hljs-attr">Namespace:</span>    default
...
<span class="hljs-attr">Spec:</span>
<span class="hljs-attr">  Hosts:</span>
    productcatalogservice
<span class="hljs-attr">  Http:</span>
<span class="hljs-attr">    Route:</span>
<span class="hljs-attr">      Destination:</span>
<span class="hljs-attr">        Host:</span>    productcatalogservice
<span class="hljs-attr">        Subset:</span>  v1
</code></pre>
<p>However, the new service version performs well and we can route more user traffic towards it.</p>
<p>Apply the following policy:</p>
<pre><code>$ kubectl -n default apply -f ./release/istio/productcatalogservice-vs-2.yaml
</code></pre><p>Inspect its content:</p>
<pre><code>$ kubectl -n default describe vs productcatalog
</code></pre><pre><code class="lang-yaml"><span class="hljs-attr">Name:</span>         productcatalogservice
<span class="hljs-attr">Namespace:</span>    default
...
<span class="hljs-attr">Spec:</span>
<span class="hljs-attr">  Hosts:</span>
    productcatalogservice
<span class="hljs-attr">  Http:</span>
<span class="hljs-attr">    Route:</span>
<span class="hljs-attr">      Destination:</span>
<span class="hljs-attr">        Host:</span>    productcatalogservice
<span class="hljs-attr">        Subset:</span>  v1
<span class="hljs-attr">      Weight:</span>    <span class="hljs-number">50</span>
<span class="hljs-attr">      Destination:</span>
<span class="hljs-attr">        Host:</span>    productcatalogservice
<span class="hljs-attr">        Subset:</span>  v2
<span class="hljs-attr">      Weight:</span>    <span class="hljs-number">50</span>
</code></pre>
<p>This time we distribute the event portion of traffic to both service versions. 50% of the traffic will be routed to the version <code>v1</code> and 50% of the traffic will be routed to the version <code>v2</code>.</p>
<p>In a while, the version routing should be reflected in the Kiali graph:</p>
<p><img src="../assets/images/traffic-shifting-4.png" alt=""></p>
<p>Again, we should inspect metrics in the Grafana dashboard to ensure that the communication to the new service version is healthy.</p>
<p>If the communication is healthy, apply the last policy to redirect 100% of the traffic to the version <code>v2</code> of the <code>productcatalog</code> service:</p>
<pre><code>$ kubectl -n default apply -f ./release/istio/productcatalogservice-vs-3.yaml
</code></pre><p>Inspect its content:</p>
<pre><code>$ kubectl -n default describe vs productcatalog
</code></pre><pre><code class="lang-yaml"><span class="hljs-attr">Name:</span>         productcatalogservice
<span class="hljs-attr">Namespace:</span>    default
...
<span class="hljs-attr">Spec:</span>
<span class="hljs-attr">  Hosts:</span>
    productcatalogservice
<span class="hljs-attr">  Http:</span>
<span class="hljs-attr">    Route:</span>
<span class="hljs-attr">      Destination:</span>
<span class="hljs-attr">        Host:</span>    productcatalogservice
<span class="hljs-attr">        Subset:</span>  v2
</code></pre>
<p>The canary deployment for the <code>productcatalog</code> service is complete:</p>
<p><img src="../assets/images/traffic-shifting-5.png" alt=""></p>
<h2 id="exercises">Exercises</h2>
<ol>
<li>Conduct canary deployment for the <code>v3</code> version of the <code>shipping</code> service. Include used Istio policies and screenshots from Kiali and Grafana in your report.</li>
</ol>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="traffic-routing.html" class="navigation navigation-prev " aria-label="Previous page: Traffic routing">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="fault-injection.html" class="navigation navigation-next " aria-label="Next page: Fault injection">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Traffic shifting","level":"4.3","depth":1,"next":{"title":"Fault injection","level":"4.4","depth":1,"path":"traffic-management/fault-injection.md","ref":"traffic-management/fault-injection.md","articles":[]},"previous":{"title":"Traffic routing","level":"4.2","depth":1,"path":"traffic-management/traffic-routing.md","ref":"traffic-management/traffic-routing.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"traffic-management/traffic-shifting.md","mtime":"2020-06-07T10:33:53.285Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-04-25T21:46:32.291Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

